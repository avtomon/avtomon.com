<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <!--[if lt IE 9]><script src="/vendor/bower-asset/html5shiv/dist/html5shiv.min.js"></script><![endif]-->
    <title>Регистрация</title>
    <link type="text/css" rel="stylesheet" href="/vendor/bower-asset/materialize/dist/css/materialize.min.css"  media="screen,projection"/>
    <link rel="stylesheet" type="text/css" href="/html/css/main.min.css"/>
    <link rel="stylesheet" type="text/css" href="/html/css/style.min.css"/>
</head>
<body>
    <div class="grad">
        <div class="container">

            <div class="header">
                <div class="logodiv">
                    <span class="headerlogo"><a href="/" class="no_underline">avtomon.com</a></span>
                    <span class="menu_up">
                        <span class="headersearch">
                        <script defer>
                            (function() {
                                var cx = '006927285580439326900:is0xj4fvtk4';
                                var gcse = document.createElement('script');
                                gcse.type = 'text/javascript';
                                gcse.async = true;
                                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                                        '//cse.google.com/cse.js?cx=' + cx;
                                var s = document.getElementsByTagName('script')[0];
                                s.parentNode.insertBefore(gcse, s);
                            })();
                        </script>
                        <gcse:searchbox-only></gcse:searchbox-only>
                    </span>
                        <span class="mainmenu"><a href="/login">Вход</a></span>
                        <span class="mainmenu separator">|</span>
                        <span class="mainmenu"><a href="#">Регистрация</a></span>
                    </span>
                </div>

                <div class="headermenu">
                    <ul>
                        <li id="headermenunews">
                            <a href="/news" class="PTSR">
                                <span>Новости</span>
                            </a>
                        </li>
                        <li id="headermenuprojects">
                            <a href="/projects" class="PTSR">
                                <span>Проекты</span>
                            </a>
                        </li>
                        <li id="headermenuarticles">
                            <a href="/articles" class="PTSR">
                                <span>Статьи</span>
                            </a>
                        </li>
                        <li id="headeropinions">
                            <a href="/views" class="PTSR">
                                <span>Мнения</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="content6">
                <form enctype="multipart/form-data" method="POST" phpClass="User" phpMethod="register" for="insert" id="user">
                    <div class="content6reg">
                        <h1 class="PTSR">Регистрация<a href="/login">войти</a></h1>
                    </div>
                    <div class="content6img">
                        <img class="avatar_img" src="/html/icons/user_big.png">
                        <span class="button waves-effect waves-light file_dialog" style="margin: 0; float: right;">Загрузить фото</span>
                        <input type="file" name="avatar" id="avatar" alt="Фото">
                    </div>
                    <div class="content6form">
                        <div class="input-field">
                            <input id="login" type="text" class="validate required" name="login" min="3" required>
                            <label for="login">Логин</label>
                            <div class="note">Не менее 3 символов</div>
                        </div>

                        <div class="input-field">
                            <input id="email" type="email" class="validate required" name="email" required>
                            <label for="email">Почта</label>
                        </div>

                        <div class="input-field" style="width: 360px">
                            <a id="show_password">Показать</a>
                            <input id="password" type="password" class="validate required" min="6" required style="margin-bottom: 0">
                            <label for="password">Пароль</label>
                            <div class="note">Не менее 6 символов</div>
                        </div>

                        <div>
                            <select multiple class="chosen" data-placeholder="Выберите Ваши интересы" id="interests" name="interests[]">
                                <option class="in_text_tag in_val_id clone parent"></option>
                            </select>
                        </div>

                        <input type="hidden" name="hash" id="hash">

                        <div class="content6buttonsent"><span class="button waves-effect waves-light save">Отправить</span></div>
                    </div>
                </form>
            </div>


            <div class="footer">
                <div class="footerlinks">
                    <a href="/news">Новости</a>
                    |
                    <!--<a href="1.html"><span>Заметки</span></a><span>|</span>-->
                    <a href="/projects">Проекты</a>
                    |
                    <a href="/articles">Статьи</a>
                    |
                    <a href="/views">Мнения</a>
                    <span class="footersocnet PTSR">Представительства в социальных сетях</span>
                </div>

                <div class="footersocnetdiv">
                    <a href="https://vk.com/avtomon" target="_blank" id="vk"></a>
                    <a target="_blank" href="https://www.facebook.com/groups/avtomon/" id="fb"></a>
                    <a href="#" id="tw"></a>
                    <a href="#" id="gl"></a>
                </div>

                <div class="footerallright">
                    <p class="footerallrightavcom"><span class="footerallrightlogo">avtomon.com </span>© 2014</p>

                    <p class="footerallrighttext">Все права защищены. Полное или частичное копирование материалов запрещено,
                        при согласованном использовании материалов необходима ссылка на ресурс. Полное или частичное
                        копирование произведений запрещено, согласование использования произведений производится с их
                        авторами.</p>

                    <p class="footerallrightsearch">
                        <script defer>
                            (function() {
                                var cx = '006927285580439326900:is0xj4fvtk4';
                                var gcse = document.createElement('script');
                                gcse.type = 'text/javascript';
                                gcse.async = true;
                                gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +
                                        '//cse.google.com/cse.js?cx=' + cx;
                                var s = document.getElementsByTagName('script')[0];
                                s.parentNode.insertBefore(gcse, s);
                            })();
                        </script>
                        <gcse:searchbox-only></gcse:searchbox-only>
                    </p>
                </div>
            </div>


        </div>
    </div>
</body>
<script src="/vendor/bower-asset/jquery/dist/jquery.min.js"></script>
<script src="/vendor/bower-asset/materialize/dist/js/materialize.min.js"></script>
<script src="/vendor/avtomon/applyAjax.js/apply.ajax.min.js"></script>
<script src="/vendor/avtomon/myForm/myForm.min.js" defer></script>
<link rel="stylesheet" href="/vendor/bower-asset/chosen/chosen.css">
<script src="/vendor/bower-asset/chosen/chosen.jquery.js" defer></script>
<script src="/vendor/avtomon/jQuery-MD5/jquery.md5.js" defer></script>
<script src="/vendor/avtomon/pStrength/pStrength.jquery.js" defer></script>
<script>
    $(function ()
    {
        $('#password').pstrength();

        var image = new Image(),
            canvas = document.createElement('CANVAS'),
            ctx = canvas.getContext('2d'),
            thumb;

        var loginRedirect = function ()
        {
            if (window.location.href.match(/referer=.+/))
            {
                var referer = window.location.href.match(/referer=.+/)[0].replace('referer=', '');

                if (referer)
                {
                    if (referer.indexOf('/') !== 0)
                    {
                        referer = '/' + referer;
                    }
                }
            }
            else
            {
                referer = '/';
            }
            window.location = referer;
        };

        var params = {
            class: 'User',
            method: 'getInterests'
        };
        request(params, true, 'GET', function (data)
        {
            if (data.success)
            {
                setMultiData(data, $('.in_text_tag.clone'));
                $('select:not(.chosen)').material_select();
                $('.chosen').chosen();
            }
        });

        function handleFileSelect (e, element)
        {
            var file = e.target.files[0],
                URL = window.URL || window.webkitURL;

            if (URL) {
                var imageUrl = URL.createObjectURL(file);
                element.attr('src', imageUrl);
            }

            imgLoadHandler = function()
            {
                var new_width, new_height;

                if (image.height > image.width)
                {
                    new_height = 50;
                    new_width = image.width * new_height / image.height;
                }
                else
                {
                    new_width = 50;
                    new_height = image.height * new_width / image.width;
                }
                canvas.width = new_width;
                canvas.height = new_height;

                ctx.drawImage(image, 0, 0, new_width, new_height);

                canvas.toBlob( function (blob)
                {
                    thumb = blob;
                }, 'image/jpeg', 0.9)

                URL.revokeObjectURL(image.src);
            };

            image.onload = imgLoadHandler;
            image.src = imageUrl;

            $('.avatar_img').parent().append(canvas);
        }

        $('#avatar').on('change', function (e)
        {
            handleFileSelect (e, $('.avatar_img'));
        });

        $('body').on('click', '.file_dialog', function ()
        {
            $(this).siblings('input[type=file]').click();
        });

        $('.button.save:not(.disabled)').click( function ()
        {
            var f = $('form#user'),
                fd = new FormData(f.get(0));
            $(this).addClass('disabled');
            $.ajax({
                type: 'POST',
                url: "/router.php",
                dataType: 'json',
                data: fd,
                async: true,
                contentType: false,
                processData: false,
                beforeSend: function ()
                {
                    var l = fd.get('login');
                    fd.set('hash', $.md5(l + fd.get('password')));

                    if (thumb)
                    {
                        fd.append('thumb', thumb, l + '_thumb.jpg');
                    }
                    fd.append('class', f.attr('phpClass'));
                    fd.append('method', f.attr('phpMethod'));
                    fd.append('get_instance', f.attr('getInstance') ? f.attr('getInstance') : 0);
                    fd.append('static_method', f.attr('staticMethod') ? f.attr('staticMethod') : 0);
                    fd.append('pagecache_flush', f.attr('pagecacheFlush') ? f.attr('pagecacheFlush') : 1);

                    var is_insert = false;
                    if (f.attr('for') == 'insert')
                    {
                        is_insert = true;
                    }

                    f.find('input[name]:not([type=file]), textarea[name], select[name]').each( function ()
                    {
                        var t = $(this),
                                v = t.val(),
                                min = t.attr('min');
                        if (!t.prop('multiple'))
                        {
                            t.val($.trim(v));
                        }
                        if (is_insert)
                        {
                            if (!v)
                            {
                                if (!t.hasClass('required'))
                                {
                                    t.prop('disabled', true);
                                }
                                else
                                {
                                    t.addClass('invalid');
                                    t.formError('Обязательное поле не заполнено');
                                }
                            }
                            if (min)
                            {
                                if (v.length < min)
                                {
                                    $(this).formError('Количество символов в поле не должно быть менее ' + min);
                                }
                            }
                        }
                    });
                    if (f.find('*.invalid:not(:disabled)').length)
                    {
                        showError('Есть некорректно заполненые поля');
                        return false;
                    }
                },
                success: function (data)
                {
                    if (data.error !== undefined)
                    {
                        error('Произошла ошибка: ' + data.error);
                    }
                    else if (data.redirect !== undefined)
                    {
                        window.location = data.redirect;
                    }
                    else if (data.success !== undefined)
                    {
                        //window.location = '/';
                        loginRedirect();
                    }
                    else
                    {
                        error('Произошла ошибка');
                    }
                },
                error: function (XMLHttpRequest, textStatus)
                {
                    error('Произошла ошибка ' + textStatus);
                    f.find('*:disabled').prop('disabled', false);
                    setTimeout( function ()
                    {
                        $('.save').removeClass('disabled');
                    }, 500);
                }
            });
        });

        $('#show_password').click( function ()
        {
            var p = $(this).next();
            if (p.attr('type') == 'password')
            {
                p.attr('type', 'text');
                $(this).text('Скрыть');
            }
            else
            {
                p.attr('type', 'password');
                $(this).text('Показать');
            }
        })

    });
</script>
</html>